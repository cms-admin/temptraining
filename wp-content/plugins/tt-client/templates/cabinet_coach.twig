{% extends "cabinet_base.twig" %}

{% block title %}Личный кабинет тренера{% endblock %}

{% block header %}
<section class="dash-header">
  <figure class="dash-header__image">
    <img src="{{coach.photo|resize(100, 100, 'top-center')}}" alt="{{coach.coach_name}}">
  </figure>
  <div class="dash-header__data">
    <h3 class="title">{{coach.post_title}}</h3>
    <div class="text coach-text">
      {{coach.spec}}

      <label id="coach_noty_toggle">
        <input type="checkbox" value="{{coach.coach_id}}" name="coach_noty" {% if coach.notify == 1 %}checked="checked"{% endif %}>
        <span>Уведомления о платежах</span>
      </label>
    </div>
  </div>
  {% if coach.reward_history %}
  <button class="dash-header__tile slide-toggle is-blue" rel="#totalRewardHistory">
    <figure class="dash-header__tile-icon">
      <img src="{{icons_url}}time-is-money.svg" alt="История выплат" />
    </figure>
    <span>История</span>
  </button>
  {% endif %}
  <button class="dash-header__tile slide-toggle" rel="#totalPayHistory">
    <figure class="dash-header__tile-icon">
      <img src="{{icons_url}}wallet.svg" alt="Вознаграждение" />
    </figure>
    <span>{{coach.reward|number_format(0, '.', ' ')}}</span>
  </button>
  <div class="dash-header__tile is-orange">
    <figure class="dash-header__tile-icon">
      <img src="{{icons_url}}budget.svg" alt="Налог" />
    </figure>
    <span>{{coach.tax|number_format(0, '.', ' ')}}</span>
  </div>
</section>
{# ИСТОРИЯ ВЫПЛАТ ТРЕНЕРА #}
{% if coach.reward_history|length > 0 %}
<div id="totalRewardHistory" class="dash-coaches" style="display: none;" data-list=""
  {% if coach.reward_history|length > 5 %} data-list-pages="5"{% endif %}
  data-list-options='{"valueNames": ["date", "sum"], "listClass": "history-list"}'>
  <ul class="history-list has-separate">
    {% for reward in coach.reward_history %}
    <li>
      <div class="client-row history-row">
        <i class="jstree-icon jstree-themeicon" role="presentation"></i>
      
        <span class="fix-2">
          <i class="ion ion-calendar"></i>&nbsp;
          <span class="date {% if reward.pays %} slide-toggle{% endif %}"
            {% if reward.pays %} rel="#reward_history_{{reward.id}}"{% endif %}>
            {{reward.payment_date|date("d.m.Y")}}
          </span>
        </span>

        {% if reward.type == 1 %}
          <span class="fix-2"><i class="ion ion-card"></i>&nbsp;<span>Вознаграждение</span></span>
        {% else %}
          <span class="fix-2"><i class="ion ion-calculator"></i>&nbsp;<span>Налог</span></span>
        {% endif %}

        <span class="fix-2">
          <i class="ion ion-cash"></i>&nbsp;
          <span class="sum">{{reward.amount|number_format(2, '.', ' ')}}</span>
        </span>
      </div>
      {# ДЕТАЛИЗАЦИЯ ВЫПЛАТЫ ТРЕНЕРА #}
      {% if reward.pays %}
      <div id="reward_history_{{reward.id}}" style="display: none">
        <ul class="history-list has-pays">
          {% for pay in reward.pays %}
          <li class="client-row history-row">
            <i class="jstree-icon jstree-themeicon" role="presentation"></i>
            <span class="fix-2 client-row__placeholder"></span>
            <span class="fix-2">{{pay.client_name}}</span>
            <span class="fix-1">{{pay.wage|number_format(0, '.', ' ')}}</span>
            <span class="fix-1">{{pay.period}} {{pay.period_title}}</span>
            <span class="fix-2">{{pay.client_tarif_name}}</span>
            <span>{{pay.date|date("d.m.Y")}}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </li>
    {% endfor %}
  </ul>   
  {% if coach.reward_history|length > 5 %}<div class="listjs-pagination"></div>{% endif %}
</div>
{% endif %}

{# ИСТОРИЯ ПЛАТЕЖЕЙ КЛИЕНТОВ ПО НАКОПЛЕННОЙ СУММЕ #}
<div id="totalPayHistory" class="dash-coaches" style="display: none;" data-list="" 
  {% if coach.pays|length > 5 %}data-list-pages="5"{% endif %}
  data-list-options='{"valueNames": ["date", "sum"], "listClass": "history-list"}'>
  <ul class="history-list">
    {% for pay in coach.pays %}
    <li id="coach_pay_{{pay.id}}" class="client-row history-row">
      <i class="jstree-icon jstree-themeicon" role="presentation"></i>
      <span class="fix-2">
        <i class="ion ion-calendar"></i>&nbsp;
        <span class="date">{{pay.date|date("d.m.Y")}}</span>
      </span>
      <span class="fix-2">
        <i class="ion ion-person"></i>&nbsp;
        <span class="date">{{pay.client_name}}</span>
      </span>
      <span class="fix-flex sum">{{pay.wage|number_format(0, '.', ' ')}}</span>
    </li>
    {% endfor %}
  </ul>
</div>
{% endblock %}

{% block content %}
{% if coach.clients %}
  <div id="dashCoachClients" class="dash-coaches is-coach jstree">
    <ul>
      {% for client in coach.clients %}
        {% if client.notify == 1 %}
          {% set noty_class = 'active' %}
          {% set noty_icon = 'ion-android-notifications' %}
        {% else %}
          {% set noty_class = 'disable' %}
          {% set noty_icon = 'ion-android-notifications-off' %}
        {% endif %}
        <li id="client_{{client.client_id}}" class="client-row{% if client.history %} has-history{% endif %}">
          <span class="fix-2">{{client.client_name}}</span>
          <span class="fix-2 hidden-xm hidden-sm hidden-xs hidden-xx">{{client.client_id_name}}</span>
          <span class="fix-flex hidden-sm hidden-xs hidden-xx">{{client.client_tarif_name}}</span>
          <span class="fix-1 visible-sm visible-xs visible-xx">{{client.tarif_cost}}</span>
          <span class="fix-1 fix-xs-1 fix-xx-2 {{client.pay_class}}">
            {% if client.pay_date != '0000-00-00 00:00:00' %}{{client.pay_date|date("d.m.Y")}}{% else %}не установлено{% endif %}
            {% if client.pay_interval %} ({{client.pay_interval}}){% endif %}
          </span>
          <span class="{{noty_class}}"><i class="ion {{noty_icon}}"></i></span>
          {% if client.history %}
            <button class="jstree-toggle client-row__btn">
              <img src="{{icons_url}}credit-card-2.svg" alt="История платежей" />
            </button>
            <ul>
              {% for pay in client.history %}
                <li class="client-row{% if pay.wait %} is-waiting{% endif %}">
                  <span class="fix-2 client-row__placeholder"></span>
                  <span class="fix-2">{% if pay.wait %}не выплачено{% else %}выплачено{% endif %}</span>
                  <span class="fix-2">{{pay.wage|number_format(2, '.', ' ')}} руб.</span>
                  <span class="fix-2">{{pay.period_title}}</span>
                  <span class="fix-flex">{{pay.date|date("d.m.Y")}}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <span class="client-row__btn">
              <img src="{{icons_url}}credit-card-1.svg" alt="История платежей" />
            </span>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

{% include('offers.twig') %}

{% endblock %}